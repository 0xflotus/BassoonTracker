var BassoonTracker=function(){function M(e,t){function i(e){(e=0===e?e:e||o.index)<0&&(e=0),e>=o.length&&(e=o.length-1),o.index=e}var o={index:0,litteEndian:!t,goto:function(e){i(e)},jump:function(e){this.goto(this.index+e)},readByte:function(e){i(e);var t=this.dataView.getInt8(this.index);return this.index++,t},writeByte:function(e,t){i(t),this.dataView.setInt8(this.index,e),this.index++},readUbyte:function(e){i(e);var t=this.dataView.getUint8(this.index);return this.index++,t},writeUByte:function(e,t){i(t),this.dataView.setUint8(this.index,e),this.index++},readUint:function(e){i(e);var t=this.dataView.getUint32(this.index,this.litteEndian);return this.index+=4,t},writeUint:function(e,t){i(t),this.dataView.setUint32(this.index,e,this.litteEndian),this.index+=4},readBytes:function(e,t){i(t);var n=new Uint8Array(e),r=this.index;(e+=r)>this.length&&(e=this.length);for(var a=0;r<e;++r)n.setUint8(a++,this.dataView.getUint8(r));return this.index=e,n},readString:function(e,t){i(t);var n=this.index,r=this.dataView,a="";for((e+=n)>this.length&&(e=this.length);n<e;++n){var o=r.getUint8(n);if(0==o)break;a+=String.fromCharCode(o)}return this.index=e,a},writeString:function(e,t){i(t);for(var n=this.dataView,r=e.length,a=0;a<r;a++)n.setUint8(this.index+a,e.charCodeAt(a));this.index+=r},writeStringSection:function(e,t,n,r){i(r),t=t||1,n=n||0;var a=(e=e||"").length;t<a&&(e=e.substr(0,t)),o.writeString(e),o.fill(n,t-a)},readWord:function(e){i(e);var t=this.dataView.getUint16(this.index,this.litteEndian);return this.index+=2,t},writeWord:function(e,t){i(t),this.dataView.setUint16(this.index,e,this.litteEndian),this.index+=2}};return o.readLong=o.readDWord=o.readUint,o.writeLong=o.writeDWord=o.writeUint,o.readShort=function(e,t){i(t);var n=this.dataView.getInt16(this.index,this.litteEndian);return this.index+=2,n},o.clear=function(e){o.fill(0,e)},o.fill=function(e,t){e=e||0,t=t||0;for(var n=0;n<t;n++)o.writeByte(e)},o.isEOF=function(e){return e=e||0,this.index>=this.length-e},o.buffer=e,o.dataView=new DataView(e),o.length=e.byteLength,o}var o,A={images:{},audio:{},json:{},arrayBuffer:{}},I=void 0,s=1,x=2,H=1,z=2,K=3,X=4,Q=5,p=7,Z=8,J=9,Y=10,$=12,W=13,ee=16,te=17,ne=24,re=26,ae=28,oe=29,m=33,t=36,u=46,ie=1,se=2,c=1,f=2,v=3,C=1,k=2,ue={C1:{period:856,name:"C-1",tune:[907,900,894,887,881,875,868,862,856,850,844,838,832,826,820,814]},Cs1:{period:808,name:"C#1",tune:[856,850,844,838,832,826,820,814,808,802,796,791,785,779,774,768]},D1:{period:762,name:"D-1",tune:[808,802,796,791,785,779,774,768,762,757,752,746,741,736,730,725]},Ds1:{period:720,name:"D#1",tune:[762,757,752,746,741,736,730,725,720,715,709,704,699,694,689,684]},E1:{period:678,name:"E-1",tune:[720,715,709,704,699,694,689,684,678,674,670,665,660,655,651,646]},F1:{period:640,name:"F-1",tune:[678,675,670,665,660,655,651,646,640,637,632,628,623,619,614,610]},Fs1:{period:604,name:"F#1",tune:[640,636,632,628,623,619,614,610,604,601,597,592,588,584,580,575]},G1:{period:570,name:"G-1",tune:[604,601,597,592,588,584,580,575,570,567,563,559,555,551,547,543]},Gs1:{period:538,name:"G#1",tune:[570,567,563,559,555,551,547,543,538,535,532,528,524,520,516,513]},A1:{period:508,name:"A-1",tune:[538,535,532,528,524,520,516,513,508,505,502,498,495,491,487,484]},As1:{period:480,name:"A#1",tune:[508,505,502,498,494,491,487,484,480,477,474,470,467,463,460,457]},B1:{period:453,name:"B-1",tune:[480,477,474,470,467,463,460,457,453,450,447,444,441,437,434,431]},C2:{period:428,name:"C-2",tune:[453,450,447,444,441,437,434,431,428,425,422,419,416,413,410,407]},Cs2:{period:404,name:"C#2",tune:[428,425,422,419,416,413,410,407,404,401,398,395,392,390,387,384]},D2:{period:381,name:"D-2",tune:[404,401,398,395,392,390,387,384,381,379,376,373,370,368,365,363]},Ds2:{period:360,name:"D#2",tune:[381,379,376,373,370,368,365,363,360,357,355,352,350,347,345,342]},E2:{period:339,name:"E-2",tune:[360,357,355,352,350,347,345,342,339,337,335,332,330,328,325,323]},F2:{period:320,name:"F-2",tune:[339,337,335,332,330,328,325,323,320,318,316,314,312,309,307,305]},Fs2:{period:302,name:"F#2",tune:[320,318,316,314,312,309,307,305,302,300,298,296,294,292,290,288]},G2:{period:285,name:"G-2",tune:[302,300,298,296,294,292,290,288,285,284,282,280,278,276,274,272]},Gs2:{period:269,name:"G#2",tune:[285,284,282,280,278,276,274,272,269,268,266,264,262,260,258,256]},A2:{period:254,name:"A-2",tune:[269,268,266,264,262,260,258,256,254,253,251,249,247,245,244,242]},As2:{period:240,name:"A#2",tune:[254,253,251,249,247,245,244,242,240,239,237,235,233,232,230,228]},B2:{period:226,name:"B-2",tune:[240,238,237,235,233,232,230,228,226,225,224,222,220,219,217,216]},C3:{period:214,name:"C-3",tune:[226,225,223,222,220,219,217,216,214,213,211,209,208,206,205,204]},Cs3:{period:202,name:"C#3",tune:[214,212,211,209,208,206,205,203,202,201,199,198,196,195,193,192]},D3:{period:190,name:"D-3",tune:[202,200,199,198,196,195,193,192,190,189,188,187,185,184,183,181]},Ds3:{period:180,name:"D#3",tune:[190,189,188,187,185,184,183,181,180,179,177,176,175,174,172,171]},E3:{period:170,name:"E-3",tune:[180,179,177,176,175,174,172,171,170,169,167,166,165,164,163,161]},F3:{period:160,name:"F-3",tune:[170,169,167,166,165,164,163,161,160,159,158,157,156,155,154,152]},Fs3:{period:151,name:"F#3",tune:[160,159,158,157,156,155,154,152,151,150,149,148,147,146,145,144]},G3:{period:143,name:"G-3",tune:[151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136]},Gs3:{period:135,name:"G#3",tune:[143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128]},A3:{period:127,name:"A-3",tune:[135,134,133,132,131,130,129,128,127,126,125,125,124,123,122,121]},As3:{period:120,name:"A#3",tune:[127,126,125,125,123,123,122,121,120,119,118,118,117,116,115,114]},B3:{period:113,name:"B-3",tune:[120,119,118,118,117,116,115,114,113,113,112,111,110,109,109,108]}},le={None:{name:"---"},C0:{name:"C-0",period:6848},Cs0:{name:"C#0",period:6464},D0:{name:"D-0",period:6096},Ds0:{name:"D#0",period:5760},E0:{name:"E-0",period:5424},F0:{name:"F-0",period:5120},Fs0:{name:"F#0",period:4832},G0:{name:"G-0",period:4560},Gs0:{name:"G#0",period:4304},A0:{name:"A-0",period:4064},As0:{name:"A#0",period:3840},B0:{name:"B-0",period:3624},C1:{name:"C-1",period:3424},Cs1:{name:"C#1",period:3232},D1:{name:"D-1",period:3048},Ds1:{name:"D#1",period:2880},E1:{name:"E-1",period:2712},F1:{name:"F-1",period:2560},Fs1:{name:"F#1",period:2416},G1:{name:"G-1",period:2280},Gs1:{name:"G#1",period:2152},A1:{name:"A-1",period:2032},As1:{name:"A#1",period:1920},B1:{name:"B-1",period:1812},C2:{name:"C-2",period:1712},Cs2:{name:"C#2",period:1616},D2:{name:"D-2",period:1524},Ds2:{name:"D#2",period:1440},E2:{name:"E-2",period:1356},F2:{name:"F-2",period:1280},Fs2:{name:"F#2",period:1208},G2:{name:"G-2",period:1140},Gs2:{name:"G#2",period:1076},A2:{name:"A-2",period:1016},As2:{name:"A#2",period:960},B2:{name:"B-2",period:906},C3:{name:"C-3",period:856},Cs3:{name:"C#3",period:808},D3:{name:"D-3",period:762},Ds3:{name:"D#3",period:720},E3:{name:"E-3",period:678},F3:{name:"F-3",period:640},Fs3:{name:"F#3",period:604},G3:{name:"G-3",period:570},Gs3:{name:"G#3",period:538},A3:{name:"A-3",period:508},As3:{name:"A#3",period:480},B3:{name:"B-3",period:453},C4:{name:"C-4",period:428},Cs4:{name:"C#4",period:404},D4:{name:"D-4",period:381},Ds4:{name:"D#4",period:360},E4:{name:"E-4",period:339},F4:{name:"F-4",period:320},Fs4:{name:"F#4",period:302},G4:{name:"G-4",period:285},Gs4:{name:"G#4",period:269},A4:{name:"A-4",period:254},As4:{name:"A#4",period:240},B4:{name:"B-4",period:226.5,modPeriod:226},C5:{name:"C-5",period:214},Cs5:{name:"C#5",period:202},D5:{name:"D-5",period:190.5,modPeriod:190},Ds5:{name:"D#5",period:180},E5:{name:"E-5",period:169.5,modPeriod:170},F5:{name:"F-5",period:160},Fs5:{name:"F#5",period:151},G5:{name:"G-5",period:142.5,modPeriod:143},Gs5:{name:"G#5",period:134.5,modPeriod:135},A5:{name:"A-5",period:127},As5:{name:"A#5",period:120},B5:{name:"B-5",period:113.25,modPeriod:113},C6:{name:"C-6",period:107},Cs6:{name:"C#6",period:101},D6:{name:"D-6",period:95.25,modPeriod:95},Ds6:{name:"D#6",period:90},E6:{name:"E-6",period:84.75,modPeriod:85},F6:{name:"F-6",period:80},Fs6:{name:"F#6",period:75.5,modPeriod:75},G6:{name:"G-6",period:71.25,modPeriod:71},Gs6:{name:"G#6",period:67.25,modPeriod:67},A6:{name:"A-6",period:63.5,modPeriod:63},As6:{name:"A#6",period:60},B6:{name:"B-6",period:56.625,modPeriod:56},C7:{name:"C-7",period:53.5,modPeriod:53},Cs7:{name:"C#7",period:50.5,modPeriod:50},D7:{name:"D-7",period:47.625,modPeriod:47},Ds7:{name:"D#7",period:45},E7:{name:"E-7",period:42.375,modPeriod:42},F7:{name:"F-7",period:40},Fs7:{name:"F#7",period:37.75,modPeriod:37},G7:{name:"G-7",period:35.625,modPeriod:35},Gs7:{name:"G#7",period:33.625,modPeriod:33},A7:{name:"A-7",period:31.75,modPeriod:31},As7:{name:"A#7",period:30},B7:{name:"B-7",period:28.3125,modPeriod:28},C8:{name:"C-8",period:26.75},Cs8:{name:"C#8",period:25.25},D8:{name:"D-8",period:23.8125},Ds8:{name:"D#8",period:22.5},E8:{name:"E-8",period:21.1875},F8:{name:"F-8",period:20},Fs8:{name:"F#8",period:18.875},G8:{name:"G-8",period:17.8125},Gs8:{name:"G#8",period:16.8125},A8:{name:"A-8",period:15.875},As8:{name:"A#8",period:15},B8:{name:"B-8",period:14.15625},C9:{name:"C-9",period:13.375},Cs9:{name:"C#9",period:12.625},D9:{name:"D-9",period:11.90625},Ds9:{name:"D#9",period:11.25},E9:{name:"E-9",period:10.59375},F9:{name:"F-9",period:10},Fs9:{name:"F#9",period:9.4375},G9:{name:"G-9",period:8.90625},Gs9:{name:"G#9",period:8.40625},A9:{name:"A-9",period:7.9375},As9:{name:"A#9",period:7.5},B9:{name:"B-9",period:7.078125},C10:{name:"C-10",period:6.6875},Cs10:{name:"C#10",period:6.3125},D10:{name:"D-10",period:5.953125},Ds10:{name:"D#10",period:5.625},E10:{name:"E-10",period:5.296875},F10:{name:"F-10",period:5},Fs10:{name:"F#10",period:4.71875},G10:{name:"G-10",period:4.453125},Gs10:{name:"G#10",period:4.203125},A10:{name:"A-10",period:3.96875},As10:{name:"A#10",period:3.75},B10:{name:"B-10",period:3.5390625},C11:{name:"C-11",period:3.34375},Cs11:{name:"C#11",period:3.15625},D11:{name:"D-11",period:2.9765625},Ds11:{name:"D#11",period:2.8125},E11:{name:"E-11",period:2.6484375},F11:{name:"F-11",period:2.5},Fs11:{name:"F#11",period:2.359375},G11:{name:"G-11",period:2.2265625},Gs11:{name:"G#11",period:2.1015625},A11:{name:"A-11",period:1.984375},As11:{name:"A#11",period:1.875},B11:{name:"B-11",period:1.76953125},OFF:{name:"OFF",period:0}},de=145,pe=1,me=2,ce={unrollLoops:!1,unrollShortLoops:!1,sustainKeyboardNotes:!1,useHover:!0,keyboardTable:"qwerty",vubars:!0,stereoSeparation:f,emulateProtracker1OffsetBug:!0},fe=(o={},{on:function(e,t){var n=o[e];n||(n=[],o[e]=n),n.push(t)},trigger:function(e,t){var n=o[e];if(n){var r,a=n.length;for(r=0;r<a;r++)n[r](t,e)}}}),ve=function(){function r(e){(t=e.createGain()).gain.setValueAtTime(1,0),t.connect(e.destination),(o=e.createGain()).connect(t),A.setMasterVolume(1),(a=e.createBiquadFilter()).type="lowpass",a.frequency.setValueAtTime(2e4,0),a.connect(o),A.masterVolume=o,A.cutOffVolume=t,A.lowPassfilter=a}var A={};window.AudioContext=window.AudioContext||window.webkitAudioContext,window.OfflineAudioContext=window.OfflineAudioContext||window.webkitOfflineAudioContext;var x,o,t,a,B,n,i,V,M,I,U=[],s=[],u=f,l=0,D=[[],[],[]],_=0,G=4143.569,d={volume:!0,panning:!0,high:!0,mid:!0,low:!0,lowPass:!0,reverb:!0,distortion:!1},O=!1;return AudioContext&&(x=new AudioContext),A.init=function(e){function t(){var e=FilterChain(d);e.output().connect(a),U.push(e)}if(e=e||x){M=!!ve.context.createStereoPanner,I="undefined"!=typeof Editor,r(e);var n=Pe.getTrackCount();for(U=[],B=0;B<n;B++)t();A.filterChains=U,A.usePanning=M,O||(fe.on(p,function(e){void 0!==e.track&&U[e.track]&&U[e.track].volumeValue(e.mute?0:70)}),fe.on(ne,function(e){for(B=U.length;B<e;B++)t();fe.trigger(m,e),A.setStereoSeparation(u)}),fe.on(ae,function(e){A.setStereoSeparation()}))}},A.enable=function(){t.gain.setValueAtTime(1,0),A.cutOff=!1},A.disable=function(){t.gain.setValueAtTime(0,0),A.cutOff=!0;D.forEach(function(e,t){e.length,e.forEach(function(e){e.gain.cancelScheduledValues(0),e.gain.setValueAtTime(0,0)}),D[t]=[]})},A.checkState=function(){x&&"suspended"===x.state&&x.resume&&x.resume()},A.playSample=function(e,t,n,r,a,o,i){var s;O?s=V:(s=x,A.enable()),t=t||428,r=r||(I?Editor.getCurrentTrack():0),o=o||x.currentTime,i===de&&(n=0);var u,l,d,p=Pe.getInstrument(e),m=t,c=0;if(p){var f,v,g=0,h=0;n=void 0===n?100*p.sample.volume/64:n,c=(p.sample.panning||0)/128,Pe.inFTMode()?Pe.useLinearFrequency?t-=p.getFineTune()/2:p.getFineTune()&&(t=A.getFineTuneForNote(i,p.getFineTune())):p.getFineTune()&&(t=A.getFineTuneForPeriod(t,p.getFineTune())),v=A.getSampleRateForPeriod(t);var b=1;p.sample.data.length?(h=p.sample.data.length,a&&a.offset&&(a.offset.value>=h&&(a.offset.value=h-1),g=a.offset.value/s.sampleRate),f=s.createBuffer(1,h,s.sampleRate),b=v/s.sampleRate):(f=s.createBuffer(1,1,s.sampleRate),g=0);var y=f.getChannelData(0);for(B=0;B<h;B++)y[B]=p.sample.data[B];G=v;var T=s.createBufferSource();T.buffer=f;var w=s.createGain();if(w.gain.value=n/100,w.gain.setValueAtTime(n/100,o),p.sample.loop.enabled&&2<p.sample.loop.length&&(ce.unrollLoops||(T.loop=!0,T.loopStart=p.sample.loop.start/s.sampleRate,T.loopEnd=(p.sample.loop.start+p.sample.loop.length)/s.sampleRate)),p.volumeEnvelope.enabled||p.panningEnvelope.enabled||p.hasVibrato()){var P=p.noteOn(o),F=T;P.volume&&(u=P.volume,T.connect(u),F=u),P.panning&&(l=P.panning,F.connect(l),F=l),d=P.scheduled,F.connect(w)}else T.connect(w);var S=ve.context.createGain();if(S.gain.setValueAtTime(0,o),S.gain.linearRampToValueAtTime(1,o+.01),w.connect(S),M){var E=ve.context.createStereoPanner();E.pan.setValueAtTime(c,o),S.connect(E),E.connect(U[r].input())}else S.connect(U[r].input());T.playbackRate.value=b;var k=o+0;T.start(k,g);var C={source:T,volume:w,panning:E,volumeEnvelope:u,panningEnvelope:l,volumeFadeOut:S,startVolume:n,currentVolume:n,startPeriod:t,basePeriod:m,noteIndex:i,startPlaybackRate:b,sampleRate:v,instrumentIndex:e,effects:a,track:r,time:o,scheduled:d};return D[_].push(w),O||fe.trigger(W,C),C}return{}},A.playSilence=function(){if(x){var e=x.createBufferSource();e.connect(o),e.start()}},A.playRaw=function(e,t){if(x&&e&&e.length){var n;n=x.createBuffer(1,e.length,x.sampleRate);var r=t/audioContext.sampleRate,a=x.createBufferSource();a.buffer=n,a.loop=!0,a.playbackRate.value=r,a.connect(o),a.start()}},A.isRecording=function(){return n},A.startRecording=function(){if(!n&&x&&x.createMediaStreamDestination){var e=x.createMediaStreamDestination();(i=new MediaRecorder(e.stream)).ondataavailable=function(e){s.push(e.data)},i.onstop=function(e){var t=new Blob(s,{type:"audio/ogg; codecs=opus"});saveAs(t,"recording.opus")},o.connect(e),i.start(),n=!0}},A.stopRecording=function(){n&&(n=!1,i.stop())},A.startRendering=function(e){O=!0,V=new OfflineAudioContext(2,44100*e,44100),A.context=V,A.init(V)},A.stopRendering=function(t){O=!1,V.startRendering().then(function(e){t&&t(e)}).catch(function(e){}),r(A.context=x),A.init(x)},A.setStereoSeparation=function(e){var t,n=Pe.getTrackCount();if(Pe.inFTMode())t=0;else switch(e=e||u,u=e,e){case v:t=0,ce.stereoSeparation=v;break;case c:t=1,ce.stereoSeparation=c;break;default:t=.5,ce.stereoSeparation=f}for(B=0;B<n;B++){var r=U[B];r&&r.panningValue(B%2==0?-t:t)}},A.getPrevSampleRate=function(){return G},A.context=x,A.getSemiToneFrom=function(e,t,n){var r=e;if(n&&((e=A.getFineTuneBasePeriod(e,n))||(e=r)),t){var a=ge[e];if(a){var o=ye.indexOf(a.name),i=ye[o+t];if(i){var s=be[i];s&&(r=s.period,n&&(r=A.getFineTuneForPeriod(r,n)))}}}return r},A.getNearestSemiTone=function(e,t){var n=8;if(t){var r=Pe.getInstrument(t);r&&r.sample.finetune&&(n+=r.sample.finetune)}var a=1e5,o=e;for(var i in ue)if(ue.hasOwnProperty(i)){var s=ue[i].tune[n],u=Math.abs(s-e);u<a&&(a=u,o=s)}return o},A.getFineTuneForPeriod=function(e,t){var n=e,r=ge[e];if(r&&r.tune){var a=8+t;0<=a&&a<r.tune.length&&(n=r.tune[a])}return n},A.getFineTuneForNote=function(e,t){if(e===de)return 1;var n=Te[e],r=0<t?Te[e+1]:Te[e-1];if(n&&r){var a=Math.abs(r.period-n.period)/127;return n.period-a*t}return n?n.period:1e5},A.getFineTuneBasePeriod=function(e,t){var n=e,r=he[t];return r&&(n=r[e]),n},A.getSampleRateForPeriod=function(e){return Pe.inFTMode()?Pe.useLinearFrequency?8363*Math.pow(2,(4608-e)/768):3579364/e:3546895/e},A.limitAmigaPeriod=function(e){return e=Math.max(e,113),Math.min(e,856)},A.setAmigaLowPassFilter=function(e,t){var n=e?2e3:2e4;a.frequency.setValueAtTime(n,t)},A.setMasterVolume=function(e,t){t=t||x.currentTime,e*=.7,o.gain.setValueAtTime(l,t),o.gain.linearRampToValueAtTime(e,t+.02),l=e},A.slideMasterVolume=function(e,t){t=t||x.currentTime,e*=.7,o.gain.linearRampToValueAtTime(e,t),l=e},A.getLastMasterVolume=function(){return l/.7},A.clearScheduledNotesCache=function(){2<++_&&(_=0),D[_]=[]},A.waveFormFunction={sine:function(e,t,n,r){return e+Math.sin(t*n)*r*2},saw:function(e,t,n,r){var a=1-Math.abs(t*n/7%1);return e+(a=(a=2*a-1)*r*-2)},square:function(e,t,n,r){var a=Math.sin(t*n)<=0?-1:1;return e+(a=a*r*2)},sawInverse:function(e,t,n,r){var a=Math.abs(t*n/7%1);return e+(a=(a=2*a-1)*r*-2)}},A}();!function(a,o,e){function i(n,e){if(!o[n]){if(!a[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(s)return s(n,!0);throw new Error("Cannot find module '"+n+"'")}var r=o[n]={exports:{}};a[n][0].call(r.exports,function(e){var t=a[n][1][e];return i(t||e)},r,r.exports)}return o[n].exports}for(var s="function"==typeof require&&require,t=0;t<e.length;t++)i(e[t])}({1:[function(e,t,n){var r=e("./lib/WAAClock");t.exports=r,"undefined"!=typeof window&&(window.WAAClock=r)},{"./lib/WAAClock":2}],3:[function(e,t,n){var r=t.exports={};r.nextTick=function(){var e="undefined"!=typeof window&&window.setImmediate,t="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};if(t){var n=[];return window.addEventListener("message",function(e){var t=e.source;(t===window||null===t)&&"process-tick"===e.data&&(e.stopPropagation(),0<n.length)&&n.shift()()},!0),function(e){n.push(e),window.postMessage("process-tick","*")}}return function(e){setTimeout(e,0)}}(),r.title="browser",r.browser=!0,r.env={},r.argv=[],r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")}},{}],2:[function(e,t,n){var r=e("__browserify_process");if("undefined"!=typeof window&&!AudioContext)throw new Error("This browser doesn't seem to support web audio API");var a=.1,o=.001,i=function(e,t,n){this.clock=e,this.func=n,this.repeatTime=null,this.toleranceLate=a,this.toleranceEarly=o,this._armed=!1,this._latestTime=null,this._earliestTime=null,this.schedule(t)};i.prototype.clear=function(){return this.clock._removeEvent(this),this},i.prototype.repeat=function(e){if(0===e)throw new Error("delay cannot be 0");return this.repeatTime=e,this},i.prototype.tolerance=function(e){return"number"==typeof e.late&&(this.toleranceLate=e.late),"number"==typeof e.early&&(this.toleranceEarly=e.early),this._update(),this},i.prototype.isRepeated=function(){return null!==this.repeatTime},i.prototype.schedule=function(e){this._armed=!0,this.deadline=e,this._update(),this.clock.context.currentTime>=this._earliestTime&&(this.clock._removeEvent(this),this._execute())},i.prototype._execute=function(){this._armed=!1,this.clock.context.currentTime<this._latestTime?this.func(this):fe&&fe.trigger(u),!1===this._armed&&this.isRepeated()&&this.schedule(this.deadline+this.repeatTime)},i.prototype._update=function(){this._latestTime=this.deadline+this.toleranceLate,this._earliestTime=this.deadline-this.toleranceEarly,this.clock._removeEvent(this),this.clock._insertEvent(this)};var s=t.exports=function(e,t){t=t||{},this.toleranceEarly=t.toleranceEarly||o,this.toleranceLate=t.toleranceLate||a,this.context=e,this._events=[],this._started=!1};s.prototype.setTimeout=function(e,t){return this._createEvent(e,this._absTime(t))},s.prototype.callbackAtTime=function(e,t){return this._createEvent(e,t)},s.prototype.timeStretch=function(n,e,r){var a=this.context.currentTime;return e.forEach(function(e){e.isRepeated()&&e.repeat(e.repeatTime*r);var t=n+r*(e.deadline-n);if(e.isRepeated())for(;a>=t-e.toleranceEarly;)t+=e.repeatTime;e.schedule(t)}),e},s.prototype.start=function(){if(!1===this._started){var e=this;this._started=!0,this._events=[];this._clockNode=this.context.createScriptProcessor(256,1,1),this._clockNode.connect(this.context.destination),this._clockNode.onaudioprocess=function(){r.nextTick(function(){e._tick()})}}},s.prototype.stop=function(){!0===this._started&&(this._started=!1,this._clockNode.disconnect())},s.prototype._tick=function(){for(var e=this._events.shift();e&&e._earliestTime<=this.context.currentTime;)e._execute(),e=this._events.shift();e&&this._events.unshift(e)},s.prototype._createEvent=function(e,t){var n=new i(this,t,e);return n.tolerance({late:this.toleranceLate,early:this.toleranceEarly}),n},s.prototype._insertEvent=function(e){this._events.splice(this._indexByTime(e._earliestTime),0,e)},s.prototype._removeEvent=function(e){var t=this._events.indexOf(e);-1!==t&&this._events.splice(t,1)},s.prototype._indexByTime=function(e){for(var t,n=0,r=this._events.length;n<r;)t=Math.floor((n+r)/2),this._events[t]._earliestTime<e?n=t+1:r=t;return n},s.prototype._absTime=function(e){return e+this.context.currentTime},s.prototype._relTime=function(e){return e-this.context.currentTime}},{__browserify_process:3}]},{},[1]),FilterChain=function(e){function n(){if(i=o,h&&(l=l||((a=C.createBiquadFilter()).type="highshelf",a.frequency.value=3200,a.gain.value=E,a),i.connect(l),i=l),b&&(d=d||((r=C.createBiquadFilter()).type="peaking",r.frequency.value=1e3,r.Q.value=.5,r.gain.value=S,r),i.connect(d),i=d),y&&(p=p||((n=C.createBiquadFilter()).type="lowshelf",n.frequency.value=320,n.gain.value=F,n),i.connect(p),i=p),T&&(m=m||((t=C.createBiquadFilter()).type="lowpass",t.frequency.value=5e3,t),i.connect(m),i=m),w&&(c=c||C.createConvolver(),(f=f||C.createGain()).gain.value=0,i.connect(f),f.connect(c),s=c),P){var e=C.createWaveShaper();e.curve=function(e){for(var t,n="number"==typeof e?e:50,r=new Float32Array(44100),a=Math.PI/180,o=0;o<44100;++o)t=2*o/44100-1,r[o]=(3+n)*t*20*a/(Math.PI+n*Math.abs(t));return r}(400),e.oversample="4x"}var t,n,r,a;g&&(v=v||ve.context.createStereoPanner(),i.connect(v),i=v),u=u||C.createGain(),i.connect(u),s&&s.connect(u),i=u}var t={};e=e||{volume:!0,panning:!0};var o,i,s,u,l,d,p,m,c,f,v,r=(e={volume:!0,panning:!0}).volume,g=e.panning&&ve.context.createStereoPanner,h=e.high,b=e.mid,y=e.low,T=e.lowPass,w=e.reverb,P=e.distortion,F=0,S=0,E=0,a=70,k=0,C=ve.context;return(o=C.createGain()).gain.value=1,i=o,t.lowValue=function(e){if(y){if(void 0!==e){F=e,p.gain.value=20*F}return F}},t.midValue=function(e){if(b){if(void 0!==e){S=e,d.gain.value=20*S}return S}},t.highValue=function(e){if(h){if(void 0!==e){E=e,l.gain.value=20*E}return E}},t.lowPassFrequencyValue=function(e){if(T){var t=ve.context.sampleRate/2,n=Math.log(t/40)/Math.LN2,r=Math.pow(2,n*(e-1));m.frequency.value=t*r}},t.lowPassQualityValue=function(e){T&&(m.Q.value=30*e)},t.reverbValue=function(e){if(w){if(!c.buffer){var t=A.audio["data/reverb/sportcentre.m4a"];if(t)c.buffer=t;else B().load(["data/reverb/sportcentre.m4a"],x,function(){c.buffer=A.audio["data/reverb/sportcentre.m4a"]})}var n=parseInt(e)/100;f.gain.value=n*n}},t.volumeValue=function(e){if(r){if(void 0!==e){var t=(a=e)/100;u.gain.value=t*t}return a}},t.panningValue=function(e,t){if(g)return void 0!==e&&(k=e,t?v.pan.setValueAtTime(k,t):v.pan.setValueAtTime(k,ve.context.currentTime)),k},t.setState=function(e,t){o.disconnect(),l&&l.disconnect(),d&&d.disconnect(),p&&p.disconnect(),m&&m.disconnect(),f&&f.disconnect(),v&&v.disconnect(),s=void 0,"high"===e&&(h=!!t),"mid"===e&&(b=!!t),"low"===e&&(y=!!t),"lowPass"===e&&(T=!!t),"reverb"===e&&(w=!!t),"panning"===e&&(g=!!t&&ve.context.createStereoPanner),n()},t.input=function(){return o},t.output=function(){return i},n(),t.volumeValue(a),t};var e,r,i,ge={},he={},be={},ye=[],Te=[],we=[],Pe=function(){function e(i){i=i||0,(t=t||new WAAClock(ve.context)).start(),ve.enable(),N=[],q=[];var s=(b=h.patterns[i]).length,u={},l=0,d=ve.context.currentTime+.1,p=.2,m=b,c=w;x=[],y=t.setTimeout(function(e){1<l&&(p=1,y.repeat(p));var t=e.deadline+p;for(ve.clearScheduledNotesCache();d<t;)if(G.setStateAtTime(d,{patternPos:l,songPos:c}),u.patternDelay){for(u.patternDelay--,B=0;B<S;B++)v(B,d);d+=O*W}else if(u=f(l,d,m,c),d+=O*W,s<=++l||u.patternBreak)if(u.positionBreak&&u.targetSongPosition==c||(N=[],q=[]),l=0,Pe.getPlayType()==ie){var n=u.positionBreak?u.targetSongPosition:++c;n>=h.length&&(n=h.restartPosition?h.restartPosition-1:0),n>=h.length&&(n=0),c=n,i=h.patternTable[c],(m=h.patterns[i])||(m=g(),h.patterns[i]=m),s=m.length,u.patternBreak&&((l=u.targetPatternPosition||0)>m.length&&(l=0))}else u.patternBreak&&(l=u.targetPatternPosition||0,E<l&&(l=0));for(B=0;B<S;B++){var r=R[B];if(r&&r.time&&r.scheduled){var a=G.getInstrument(r.instrumentIndex);if(r.scheduled.volume&&d+p>=r.scheduled.volume){var o=a.scheduleEnvelopeLoop(r.volumeEnvelope,r.scheduled.volume,2);r.scheduled.volume+=o}r.scheduled.panning&&d+p>=r.scheduled.panning&&(o=a.scheduleEnvelopeLoop(r.panningEnvelope,r.scheduled.panning,2),r.scheduled.panning+=o)}}},.01).repeat(p).tolerance({early:.1})}function f(e,t,n,r){for(var a,o=(n=n||b)[e],i=S,s={},u=0;u<i;u++)(l=o[u])&&l.effect&&15==l.effect&&(l.param<=32?(0==l.param&&(l.param=1),Pe.setAmigaSpeed(l.param)):Pe.setBPM(l.param));for(u=0;u<i;u++){var l=o[u];if(l){var d={position:r,step:e},p=t;if(A)p+=(Math.random()*A*2-A)/1e3;(a=m(l,u,p,d)).patternBreak&&(s.patternBreak=!0,s.targetPatternPosition=a.targetPatternPosition||0),a.positionBreak&&(s.positionBreak=!0,s.targetPatternPosition=a.targetPatternPosition||0,s.targetSongPosition=a.targetSongPosition||0),a.patternDelay&&(s.patternDelay=a.patternDelay)}}for(u=0;u<i;u++)v(u,t);return s}function m(e,t,n,r){var a=100,o={},i=e.instrument,s=e.period,u=e.index;s&&!i&&(i=R[t].currentInstrument,a="number"==typeof R[t].currentVolume?R[t].currentVolume:a,ce.emulateProtracker1OffsetBug&&i&&L[t].offset&&L[t].offset.instrument===i&&(o.offset=L[t].offset)),"number"==typeof e.instrument&&((B=G.getInstrument(e.instrument))&&(a=B.sample.volume/64*100,ce.emulateProtracker1OffsetBug&&(L[t].offset=L[t].offset||{},L[t].offset.value=0,L[t].offset.instrument=e.instrument)));var l=a,d=!0;if("number"==typeof i&&(B=G.getInstrument(i)),u&&G.inFTMode())if(97===u&&(u=de),u===de){var p=B||G.getInstrument(R[t].currentInstrument);a=l=p?p.noteOff(n,R[t]):0,d=!1}else if(B&&(B.setSampleForNoteIndex(u),B.sample.relativeNote&&(u+=B.sample.relativeNote)),G.useLinearFrequency)s=7680-64*(u-1);else{var m=Te[u];m&&(s=m.period)}var c,f,v=e.param,g={};if(e.volumeEffect&&G.inFTMode()){var h=e.volumeEffect;if(c=h>>4,f=15&h,15<h&&h<=80)a=l=(h-16)/64*100,o.volume={value:l};else switch(c){case 6:o.fade={value:-1*f*100/64};break;case 7:o.fade={value:100*f/64};break;case 8:o.fade={value:100*-f/64,fine:!0};break;case 9:o.fade={value:100*f/64,fine:!0};break;case 10:case 11:break;case 12:o.panning={value:17*(h-192),slide:!1};break;case 13:o.panning={value:h,slide:!0}}}switch(e.effect){case 0:if(v){c=v>>4,f=15&v;var b=0;if(B=B||G.getInstrument(R[t].currentInstrument),G.inFTMode()){if(B){var y=u||R[t].noteIndex,T=B.getPeriodForNote(y,!0);u===de?o.arpeggio=L[t].arpeggio:(o.arpeggio={root:T,interval1:T-B.getPeriodForNote(y+c,!0),interval2:T-B.getPeriodForNote(y+f,!0),step:1},L[t].arpeggio=o.arpeggio)}}else T=s||R[t].startPeriod,B&&((b=B.getFineTune())&&(T=ve.getFineTuneForPeriod(T,b))),o.arpeggio={root:T,interval1:T-ve.getSemiToneFrom(T,c,b),interval2:T-ve.getSemiToneFrom(T,f,b),step:1}}e.instrument&&(o.volume={value:a});break;case 1:v*=-1,G.inFTMode()&&!v&&L[t].slideUp&&(v=L[t].slideUp.value),o.slide={value:v},L[t].slideUp=o.slide;break;case 2:G.inFTMode()&&!v&&L[t].slideDown&&(v=L[t].slideDown.value),o.slide={value:v},L[t].slideDown=o.slide;break;case 3:d=!1;var w=s;if(G.inFTMode()&&u===de&&(w=0),R[t].currentInstrument&&(i=R[t].currentInstrument),w&&i)(B=G.getInstrument(i))&&B.getFineTune()&&(w=G.inFTMode()?B.getPeriodForNote(u,!0):ve.getFineTuneForPeriod(w,B.getFineTune()));(S=L[t].slide)&&(v||(v=S.value)),w||(w=L[t].defaultSlideTarget),o.slide={value:v,target:w,canUseGlissando:!0,resetVolume:!!e.instrument,volume:a},L[t].slide=o.slide,e.instrument&&(o.volume={value:a});break;case 4:e.instrument&&(R[t].startVolume&&(o.volume={value:l}),R[t].vibratoTimer=0),f=15&v;var P=(c=v>>4)*O/64,F=L[t].vibrato;0==c&&F&&(P=F.freq),0==f&&F&&(f=F.amplitude),o.vibrato={amplitude:f,freq:P},L[t].vibrato=o.vibrato;break;case 5:var S;d=!1,(w=s)&&i&&((B=G.getInstrument(i))&&B.getFineTune()&&(w=G.inFTMode()?ve.getFineTuneForNote(u,B.getFineTune()):ve.getFineTuneForPeriod(w,B.getFineTune()))),v=1,(S=L[t].slide)&&(w||(w=S.target||0),v=S.value),o.slide={value:v,target:w},L[t].slide=o.slide,e.instrument&&(o.volume={value:a}),(v=e.param)&&(e.param<16?v*=-1:v=e.param>>4,v=100*v/64,o.fade={value:v,resetOnStep:!!e.instrument},L[t].fade=o.fade);break;case 6:e.instrument&&(R[t].startVolume&&(o.volume={value:l}),R[t].vibratoTimer=0),e.param?(e.param<16?v*=-1:v=15&e.param,v=100*v/64,o.fade={value:v},L[t].fade=o.fade):Pe.inFTMode()&&L[t].fade&&(o.fade=L[t].fade),L[t].vibrato&&(o.vibrato=L[t].vibrato);break;case 7:s&&!e.instrument&&(R[t].startVolume&&(o.volume={value:l}),R[t].tremoloTimer=0);var E=f=15&v,k=(P=(c=v>>4)*O/64,L[t].tremolo);0==c&&k&&(P=k.freq),0==f&&k&&(E=k.amplitude),o.tremolo={amplitude:E,freq:P},L[t].tremolo=o.tremolo;break;case 8:o.panning={value:v,slide:!1};break;case 9:!(v<<=8)&&L[t].offset&&(v=L[t].offset.stepValue||L[t].offset.value||0);var C=v;ce.emulateProtracker1OffsetBug&&!e.instrument&&L[t].offset&&(v+=L[t].offset.value),o.offset={value:v,stepValue:C},L[t].offset=L[t].offset||{},L[t].offset.value=o.offset.value,L[t].offset.stepValue=o.offset.stepValue,ce.emulateProtracker1OffsetBug&&(e.instrument&&(L[t].offset.instrument=e.instrument),s&&(L[t].offset.value+=C)),e.instrument&&(o.volume={value:a});break;case 10:if(e.param<16?v*=-1:v=e.param>>4,v=100*v/64,!e.param){var A=L[t].fade;A&&(v=A.value)}o.fade={value:v,resetOnStep:!!e.instrument},G.inFTMode()&&(L[t].fade=o.fade);break;case 11:g.patternBreak=!0,g.positionBreak=!0,g.targetSongPosition=e.param,g.targetPatternPosition=0;break;case 12:l=e.param/64*100,o.volume={value:l};break;case 13:g.patternBreak=!0,c=v>>4,f=15&v,g.targetPatternPosition=10*c+f;break;case 14:var x=15&v;switch(v>>4){case 0:G.inFTMode()||ve.setAmigaLowPassFilter(!x,n);break;case 1:!(x*=-1)&&L[t].fineSlide&&(x=L[t].fineSlide.value),o.slide={value:x,fine:!0},L[t].fineSlide=o.slide;break;case 2:!x&&L[t].fineSlide&&(x=L[t].fineSlide.value),o.slide={value:x,fine:!0},L[t].fineSlide=o.slide;break;case 3:L[t].glissando=!!x;break;case 4:switch(x){case 1:D=ve.waveFormFunction.saw;break;case 2:D=ve.waveFormFunction.square;break;case 3:case 4:D=ve.waveFormFunction.sine;break;case 5:D=ve.waveFormFunction.saw;break;case 6:D=ve.waveFormFunction.square;break;case 7:D=ve.waveFormFunction.sine;break;default:D=ve.waveFormFunction.sine}break;case 5:if(i){var B=G.getInstrument(i);o.fineTune={original:B.getFineTune(),instrument:B},B.setFineTune(x)}break;case 6:x?(q[t]=q[t]||0,q[t]<x?(q[t]++,g.patternBreak=!0,g.positionBreak=!0,g.targetSongPosition=r.position,g.targetPatternPosition=N[t]||0):q[t]=0):N[t]=r.step;break;case 7:switch(x){case 1:_=ve.waveFormFunction.saw;break;case 2:_=ve.waveFormFunction.square;break;case 3:case 4:_=ve.waveFormFunction.sine;break;case 5:_=ve.waveFormFunction.saw;break;case 6:_=ve.waveFormFunction.square;break;case 7:_=ve.waveFormFunction.sine;break;default:_=ve.waveFormFunction.sine}break;case 8:break;case 9:x&&(o.reTrigger={value:x});break;case 10:x=100*x/64,o.fade={value:x,fine:!0};break;case 11:x=100*x/64,o.fade={value:-x,fine:!0};break;case 12:x?x<O&&(o.cutNote={value:x}):d=!1;break;case 13:x&&(x<O?n+=W*x:d=!1);break;case 14:g.patternDelay=x}break;case 15:e.param<=32?(0==e.param&&(e.param=1),Pe.setAmigaSpeed(e.param)):Pe.setBPM(e.param);break;case 16:v=Math.min(v,64),ve.setMasterVolume(v/64,n);break;case 17:c=v>>4,f=15&v;var V=64*ve.getLastMasterVolume(),M=0;if(c){var I=n+c*W;M=c*(O-1)}else f&&(I=n+f*W,M=-f*(O-1));M&&(v=(V+M)/64,v=Math.max(0,v),v=Math.min(1,v),ve.slideMasterVolume(v,I));break;case 20:G.inFTMode()&&(a=l=(p=B||G.getInstrument(R[t].currentInstrument))?p.noteOff(n,R[t]):0,d=!1);break;case 21:case 25:break;case 27:o.reTrigger={value:e.param}}return d&&i&&s&&(U(t,n),R[t]={},B&&(R[t]=B.play(u,s,l,t,o,n)),L[t].defaultSlideTarget=R[t].startPeriod),i&&(R[t].currentInstrument=i,o.fineTune&&o.fineTune.instrument&&o.fineTune.instrument.setFineTune(o.fineTune.original||0)),B&&B.hasVibrato()&&(R[t].hasAutoVibrato=!0),R[t].effects=o,R[t].note=e,g}function U(e,t){try{if(R[e].source){var n=R[e].volume.gain;n.setValueAtTime(R[e].currentVolume/100,t-.002),n.linearRampToValueAtTime(0,t),R[e].source.stop(t+.02)}}catch(e){}}function k(e,t){var n=G.getInstrument(e.instrumentIndex);if(n){var r=-n.vibrato.rate/40,a=n.vibrato.depth/8;if(G.useLinearFrequency&&(a*=4),e.vibratoTimer=e.vibratoTimer||0,n.vibrato.sweep&&e.vibratoTimer<n.vibrato.sweep)a*=1-(n.vibrato.sweep-e.vibratoTimer)/n.vibrato.sweep;var o=n.getAutoVibratoFunction()(t,e.vibratoTimer,r,a);return e.vibratoTimer++,o}return t}function v(e,t){var n=R[e],r=n.effects;if(n&&r){var a,o=!1;if(n.startVibratotimer=n.vibratoTimer||0,n.resetPeriodOnStep&&n.source){var i=n.currentPeriod||n.startPeriod;G.setPeriodAtTime(n,i,t),n.resetPeriodOnStep=!1}if(r.volume){var s=r.volume.value;n.volume&&n.volume.gain.setValueAtTime(s/100,t),n.currentVolume=s}if(r.panning&&(255===(a=r.panning.value)&&(a=254),n.panning&&n.panning.pan.setValueAtTime((a-127)/127,t)),r.fade){a=r.fade.value;var u,l=1;u=r.fade.resetOnStep?n.startVolume:n.currentVolume;var d=O;r.fade.fine&&(l=0,d=1);for(var p=l;p<d;p++)n.volume&&(n.volume.gain.setValueAtTime(u/100,t+p*W),u+=a,u=Math.max(u,0),u=Math.min(u,100));n.currentVolume=u}if(r.slide&&n.source){i=v=n.currentPeriod||n.startPeriod,d=O;r.slide.fine&&(d=2);var m=r.slide.value;if(G.inFTMode()&&G.useLinearFrequency&&(m=4*r.slide.value),a=Math.abs(m),G.inFTMode()&&r.slide.resetVolume&&(n.volumeFadeOut||n.volumeEnvelope)){var c=G.getInstrument(n.instrumentIndex);c&&c.resetVolume(t,n)}n.vibratotimer=n.startVibratotimer;for(p=1;p<d;p++){r.slide.target?(L[e].defaultSlideTarget=r.slide.target,i<r.slide.target?(i+=a)>r.slide.target&&(i=r.slide.target):(i-=a)<r.slide.target&&(i=r.slide.target)):(i+=m,L[e].defaultSlideTarget&&(L[e].defaultSlideTarget+=m)),G.inFTMode()||(i=ve.limitAmigaPeriod(i));var f=i;r.slide.canUseGlissando&&L[e].glissando&&(f=ve.getNearestSemiTone(i,n.instrumentIndex)),f!==n.currentPeriod&&(n.currentPeriod=i,n.hasAutoVibrato&&G.inFTMode()&&(i=k(n,i),o=!0),G.setPeriodAtTime(n,f,t+p*W))}}if(r.arpeggio&&n.source){var v=n.currentPeriod||n.startPeriod;n.resetPeriodOnStep=!0,n.vibratotimer=n.startVibratotimer;for(p=0;p<O;p++){var g=p%3;0==g&&(i=v),1==g&&r.arpeggio.interval1&&(i=v-r.arpeggio.interval1),2==g&&r.arpeggio.interval2&&(i=v-r.arpeggio.interval2),n.hasAutoVibrato&&G.inFTMode()&&(i=k(n,i),o=!0),G.setPeriodAtTime(n,i,t+p*W)}}if(r.vibrato||n.hasAutoVibrato&&!o){r.vibrato=r.vibrato||{freq:0,amplitude:0};var h=r.vibrato.freq,b=r.vibrato.amplitude;if(G.inFTMode()&&G.useLinearFrequency&&(b*=4),n.vibratoTimer=n.vibratoTimer||0,n.source){n.resetPeriodOnStep=!0,v=n.currentPeriod||n.startPeriod,n.vibratotimer=n.startVibratotimer;for(p=0;p<O;p++)i=D(v,n.vibratoTimer,h,b),n.hasAutoVibrato&&G.inFTMode()&&(i=k(n,i),o=!0),G.setPeriodAtTime(n,i,t+p*W)}}if(r.tremolo){h=r.tremolo.freq,b=r.tremolo.amplitude;if(n.tremoloTimer=n.tremoloTimer||0,n.volume){var y=n.startVolume;for(p=0;p<O;p++)(y=_(y,n.tremoloTimer,h,b))<0&&(y=0),100<y&&(y=100),n.volume.gain.setValueAtTime(y/100,t+p*W),n.currentVolume=y,n.tremoloTimer++}}if(r.cutNote&&(n.volume&&n.volume.gain.setValueAtTime(0,t+r.cutNote.value*W),n.currentVolume=0),r.reTrigger){var T=n.instrumentIndex,w=n.startPeriod;s=n.startVolume;for(var P=n.noteIndex,F=r.reTrigger.value||1,S=F;S<O;){var E=t+S*W;U(e,E),R[e]=ve.playSample(T,w,s,e,r,E,P),S+=F}}}}function i(){h.channels&&G.setTrackCount(h.channels),P=n=o=r=void 0,G.setCurrentSongPosition(0),G.setCurrentPatternPos(0),G.setCurrentInstrumentIndex(1),G.clearEffectCache(),fe.trigger(re,h),fe.trigger(ee,h)}function s(){G.setAmigaSpeed(6),G.setBPM(125),D=ve.waveFormFunction.sine,_=ve.waveFormFunction.sine,L=[],R=[];for(var e=0;e<S;e++)R.push({}),L.push({});G.useLinearFrequency=!1,G.setTrackerMode(pe),ve.setMasterVolume(1),ve.setAmigaLowPassFilter(!1,0)}function g(){for(var e=[],t=0;t<E;t++){var n,r=[];for(n=0;n<S;n++)r.push(Ee());e.push(r)}return e}for(var t,h,o,n,r,b,D,_,y,G={},a=!1,u=!1,l=[],d=1,p=0,c=0,T=ie,w=0,P=0,F=125,O=6,W=2.5/F,S=4,E=64,C=pe,A=0,R=[],L=[],x=[],N=[],q=[],B=0;B<S;B++)R.push({}),L.push({});G.init=function(e){for(var t=-8;t<8;t++)he[t]={};for(var n in ue)if(ue.hasOwnProperty(n)){var r=ue[n];if(ge[r.period]=r,be[r.name]=r,ye.push(r.name),r.tune)for(t=-8;t<8;t++){var a=t+8;he[t][r.tune[a]]=r.period}}var o=0;for(n in le)if(le.hasOwnProperty(n)){var i=le[n];i.period||(i.period=1),Te.push(i),we[i.period]=o,i.modPeriod&&(we[i.modPeriod]=o),o++}e&&(ve.init(),e.plugin&&I.initPlugin(e))},G.setCurrentInstrumentIndex=function(e){if(h.instruments[e])o!=(d=e)&&fe.trigger(H,d),o=d;else if(e<=G.getMaxInstruments()){for(var t=h.instruments.length,n=e;t<=n;t++)G.setInstrument(t,Se());var r=[];for(t=1;t<=n;t++){var a=h.instruments[t]||{name:""};r.push({label:t+" "+a.name,data:t}),fe.trigger(oe,r)}o!=(d=e)&&fe.trigger(H,d),o=d}},G.getCurrentInstrumentIndex=function(){return d},G.getCurrentInstrument=function(){return l[d]},G.getMaxInstruments=function(){return G.inFTMode()?128:31},G.setCurrentPattern=function(e){p=e,(b=h.patterns[p])||(b=g(),h.patterns[p]=b),E=b.length,n!=p&&fe.trigger(z,p),n=p},G.getCurrentPattern=function(){return p},G.getCurrentPatternData=function(){return b},G.updatePatternTable=function(e,t){h.patternTable[e]=t,fe.trigger(X,t),e==w&&(n=void 0,Pe.setCurrentPattern(t))},G.setCurrentPatternPos=function(e){r!=(c=e)&&fe.trigger(K,{current:c,prev:r}),r=c},G.getCurrentPatternPos=function(){return c},G.moveCurrentPatternPos=function(e){var t=c+e,n=E-1;t<0&&(t=n),n<t&&(t=0),G.setCurrentPatternPos(t)},G.getCurrentSongPosition=function(){return w},G.setCurrentSongPosition=function(e,t){(w=e)!=P&&(fe.trigger(Y,w),h.patternTable&&G.setCurrentPattern(h.patternTable[w]),P=w,t&&G.isPlaying()&&(G.stop(),G.togglePlay()))},G.addToPatternTable=function(e,t){void 0===e&&(e=h.length),t=t||0,e==h.length&&(h.patternTable[e]=t,h.length++),fe.trigger(ee,h),fe.trigger(X)},G.removeFromPatternTable=function(e){h.length<2||(void 0===e&&(e=h.length-1),e==h.length-1&&(h.patternTable[e]=0,h.length--),w==h.length&&G.setCurrentSongPosition(w-1),fe.trigger(ee,h),fe.trigger(X))},G.setPlayType=function(e){T=e,fe.trigger(J,T)},G.getPlayType=function(){return T},G.playSong=function(){G.stop(),ve.checkState(),G.setPlayType(ie),u=!0,e(p),fe.trigger(Z,u)},G.playPattern=function(){G.stop(),ve.checkState(),c=0,G.setPlayType(se),u=!0,e(p),fe.trigger(Z,u)},G.stop=function(){t&&t.stop(),ve.disable(),G.clearEffectCache();for(var e=0;e<S;e++)if(R[e].source)try{R[e].source.stop()}catch(e){}u=!1,fe.trigger(Z,u)},G.togglePlay=function(){G.isPlaying()?G.stop():T==se?G.playPattern():G.playSong()},G.getProperties=function(){return{ticksPerStep:O,tickTime:W}},G.playPatternStep=f,G.cutNote=U,G.setBPM=function(e){t&&t.timeStretch(ve.context.currentTime,[y],F/e),W=2.5/(F=e),fe.trigger($,F)},G.getBPM=function(){return F},G.setAmigaSpeed=function(e){O=e},G.getAmigaSpeed=function(){return O},G.getSwing=function(){return A},G.setSwing=function(e){A=e},G.getPatternLength=function(){return E},G.setPatternLength=function(e){E=e;var t=h.patterns[p].length;if(t!==E){if(t<E)for(var n=t;n<E;n++){var r,a=[];for(r=0;r<S;r++)a.push(Ee());h.patterns[p].push(a)}else h.patterns[p]=h.patterns[p].splice(0,E),E<=c&&G.setCurrentPatternPos(E-1);fe.trigger(z,p)}},G.getTrackCount=function(){return S},G.setTrackCount=function(e){S=e;for(var t=R.length;t<S;t++)R.push({});for(t=L.length;t<S;t++)L.push({});fe.trigger(ne,S)},G.toggleRecord=function(){G.stop(),a=!a,fe.trigger(Q,a)},G.isPlaying=function(){return u},G.isRecording=function(){return a},G.setStateAtTime=function(e,t){x.push({time:e,state:t})},G.getStateAtTime=function(e){for(var t=void 0,n=0,r=x.length;n<r;n++){if(!(x[0].time<e))return t;t=x.shift().state}return t},G.getTimeStates=function(){return x},G.setPeriodAtTime=function(e,t,n){if(t=Math.max(t,1),G.inFTMode()&&G.useLinearFrequency)var r=8363*Math.pow(2,(4608-t)/768)/ve.context.sampleRate;else r=e.startPeriod/t,r*=e.startPlaybackRate;e.source.playbackRate.setValueAtTime(r,n),e.source.playbackRate.setValueAtTime(r,n+.005)},G.load=function(n,r,a){var e,o,i,t=function(e){G.processFile(e,s,function(e){if(e){if("string"==typeof n){if(0<n.indexOf("modarchive.org")){var t=n.split("moduleid=")[1];h.filename=t.split("#")[1]||t,"modArchive","https://modarchive.org/index.php?request=view_by_moduleid&query="+(t=(t=t.split("#")[0]).split("&")[0]),fe.trigger(ee,h)}0<n.indexOf("modules.pl")&&(t=n.split("modules.pl/")[1],h.filename=t.split("#")[1]||t,"modules.pl","http://www.modules.pl/?id=module&mod="+(t=(t=t.split("#")[0]).split("&")[0]),fe.trigger(ee,h))}}e&&V(r),a&&a()})},s="";"string"==typeof(n=n||"demomods/StardustMemories.mod")?(s=n.substr(n.lastIndexOf("/")+1),e=n,o=function(e){t(e)},(i=new XMLHttpRequest).open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(e){var t=i.response;t?o&&o(t):o&&o(!1)},i.send(null)):(s=n.name||"",r=!0,t(n.buffer||n))};var V=function(e){var t=function(e){if(window.location.getParameter)return window.location.getParameter(e);if(location.search)for(var t=location.search.substring(1).split("&"),n=0;n<t.length;n++){var r=t[n].split("=");if(r[0]&&r[0]==e)return r[1]||!0}}("autoplay");e&&(t="1"),"true"!=t&&"1"!=t||Pe.playSong()};return G.handleUpload=function(e){if(e.length){var t=e[0],n=new FileReader;n.onload=function(){G.processFile(n.result,t.name,function(e){})},n.readAsArrayBuffer(t)}},G.processFile=function(e,r,a){var t=!1,n=new M(e,!0),o=Fe.detect(n,r);o&&"ZIP"==o.name&&(zip.workerScriptsPath="script/src/lib/zip/",zip.createReader(new zip.ArrayBufferReader(e),function(e){var t,n=0;e.getEntries(function(e){e&&e.length&&e.forEach(function(e){e.uncompressedSize>n&&(n=e.uncompressedSize,t=e)}),t?t.getData(new zip.ArrayBufferWriter,function(e){e&&e.byteLength&&G.processFile(e,r,a)}):a&&a(!1)})},function(e){a&&a(!1)})),o.isMod&&o.loader&&(t=!0,G.isPlaying()&&G.stop(),s(),(h=o.loader().load(n,r)).filename=r,i()),o.isSample&&Editor.importSample(n,r),a&&a(t)},G.getSong=function(){return h},G.getInstruments=function(){return l},G.getInstrument=function(e){return l[e]},G.setInstrument=function(e,t){t.instrumentIndex=e,l[e]=t},G.clearEffectCache=function(){L=[];for(var e=0;e<S;e++)L.push({})},G.clearInstruments=function(e){var t=[],n=e||h.instruments.length-1;for(l=[],B=1;B<=n;B++)G.setInstrument(B,Se()),t.push({label:B+" ",data:B});h.instruments=l,fe.trigger(oe,t),fe.trigger(H,d)},G.setTrackerMode=function(e){C=e,ce.emulateProtracker1OffsetBug=!G.inFTMode(),fe.trigger(ae,e)},G.getTrackerMode=function(){return C},G.inFTMode=function(){return C===me},G.new=function(){s(),h={patterns:[],instruments:[]},G.clearInstruments(32),h.typeId="M.K.",h.title="new song",h.length=1,h.restartPosition=0,h.patterns.push(g());for(var e=[],t=0;t<128;++t)e[t]=0;h.patternTable=e,i()},G.clearInstrument=function(){l[d]=Se(),fe.trigger(H,d),fe.trigger(te,d)},G.getFileName=function(){return h.filename||(h.title?h.title.replace(/ /g,"-").replace(/\W/g,"")+".mod":"new.mod")},G.useLinearFrequency=!0,G}(),B=function(){var o={load:function(e,t,n){o.type=t||s,o.loadCount=0,o.max=e.length,o.next=n;for(var r=0,a=e.length;r<a;r++)i(e[r])}},i=function(t){if(o.type==s){var e=new Image;e.onload=function(){A.images[t]=this,++o.loadCount==o.max&&o.next&&o.next()},e.onerror=function(){alert("BufferLoader: XHR error")},e.src=t}if(o.type==x){var n=new XMLHttpRequest;n.responseType="arraybuffer",n.open("GET",t,!0),n.onload=function(){ve.context.decodeAudioData(n.response,function(e){return e?(A.audio[t]=e,void(++o.loadCount==o.max&&o.next&&o.next())):void alert("error decoding file data: "+t)},function(e){})},n.onerror=function(){alert("BufferLoader: XHR error")},n.send()}};return o},Fe=((i={}).get=function(e,t){i.ajax({url:e,success:function(e){t(e)},error:function(e){t(void 0,e)}})},i.post=function(e,t,n){var r=t;if("object"==typeof t){for(var a in r="",t)t.hasOwnProperty(a)&&(r+="&"+a+"="+encodeURIComponent(t[a]));r.length&&(r=r.substr(1))}i.ajax({method:"POST",url:e,data:r,datatype:"form",success:function(e){n(e)},error:function(e){n(void 0,e)}})},i.sendBinary=function(e,t,n){i.ajax({method:"POST",url:e,data:t,success:function(e){n(e)},error:function(e){n(void 0,e)}})},i.json=function(e,t){void 0===t&&(t=function(){}),i.ajax({url:e,cache:!1,datatype:"json",headers:[{key:"Accept",value:"application/json"}],success:function(e){t(e)},error:function(e){t(void 0,e)}})},i.html=function(e,t){i.ajax({url:e,cache:!1,datatype:"html",success:function(e){t(e)},error:function(e){t(void 0,e)}})},i.ajax=function(t){var n=new XMLHttpRequest;t.error=t.error||function(){t.success(!1)},"jsonp"===t.datatype&&t.error(n);var e=t.url;if("boolean"==typeof t.cache&&!t.cache){var r=(new Date).getTime();e+=0<e.indexOf("?")?"&r="+r:"?r="+r}var a=t.method||"GET";n.onreadystatechange=function(){if(!(n.readyState<4)&&4===n.readyState)if(200!==n.status&&201!==n.status)t.error(n);else{var e=n.responseText;"json"===t.datatype&&(e=JSON.parse(e)),"html"===t.datatype&&((e=document.createElement("div")).innerHTML=n.responseText),t.success(e)}},n.ontimeout=function(e){},n.open(a,e,!0),n.timeout=t.timeout||3e4,t.headers&&t.headers.forEach(function(e){n.setRequestHeader(e.key,e.value)});var o=t.data||"";"POST"===a&&t.data&&"form"===t.datatype&&n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.send(o)},r={unknown:{name:"UNKNOWN"},unsupported:{name:"UNSUPPORTED"},mod_ProTracker:{name:"PROTRACKER",isMod:!0,loader:function(){return n()}},mod_SoundTracker:{name:"SOUNDTRACKER",isMod:!0,loader:function(){return a()}},mod_FastTracker:{name:"FASTTRACKER",isMod:!0,loader:function(){return l()}},sample:{name:"SAMPLE",isSample:!0},zip:{name:"ZIP"}},(e={}).detect=function(a,e){function o(e){return e<128}var i=a.length,t="";if("Extended Module: "==(t=a.readString(17,0)))return r.mod_FastTracker;if(1100<i&&(t=a.readString(4,1080)),"M.K."==t)return r.mod_ProTracker;if("M!K!"==t)return r.mod_ProTracker;if("M&K!"==t)return r.mod_ProTracker;if("FLT4"==t)return r.mod_ProTracker;if("2CHN"==t)return r.mod_ProTracker;if("6CHN"==t)return r.mod_ProTracker;if("8CHN"==t)return r.mod_ProTracker;if("10CH"==t)return r.mod_ProTracker;if("12CH"==t)return r.mod_ProTracker;if("14CH"==t)return r.mod_ProTracker;if("16CH"==t)return r.mod_ProTracker;if("18CH"==t)return r.mod_ProTracker;if("20CH"==t)return r.mod_ProTracker;if("22CH"==t)return r.mod_ProTracker;if("24CH"==t)return r.mod_ProTracker;if("26CH"==t)return r.mod_ProTracker;if("28CH"==t)return r.mod_ProTracker;if("30CH"==t)return r.mod_ProTracker;if("32CH"==t)return r.mod_ProTracker;var n="";return e&&4<e.length&&(n=e.substr(e.length-4)),".wav"==(n=n.toLowerCase())?r.sample:".mp3"==n?r.sample:".iff"==n?r.sample:".zip"==n?r.zip:"PK"==a.readString(2,0)?r.zip:e&&0<=e.indexOf(".")&&1624<i&&function(){a.goto(0);for(var e=0;e<20;e++)if(!o(a.readByte()))return!1;for(var t=0,n=0,r=0;r<15;r++){for(e=0;e<22;e++)if(!o(a.readByte()))return!1;if(a.jump(-22),"st-"==a.readString(22).toLowerCase().substr(0,3)&&(n+=10),20<n)return!0;t+=a.readWord(),a.jump(6)}return!(i<2*t+1624)}()?r.mod_SoundTracker:r.sample},e),n=function(){var e={load:function(e,t){Pe.setTrackerMode(pe),Pe.useLinearFrequency=!1;var n={patterns:[],restartPosition:1},r=4;n.typeId=e.readString(4,1080),n.title=e.readString(20,0),"2CHN"===n.typeId&&(r=2),"6CHN"===n.typeId&&(r=6),"8CHN"===n.typeId&&(r=8),"10CH"===n.typeId&&(r=10),"12CH"===n.typeId&&(r=12),"14CH"===n.typeId&&(r=14),"16CH"===n.typeId&&(r=16),"18CH"===n.typeId&&(r=18),"20CH"===n.typeId&&(r=20),"22CH"===n.typeId&&(r=22),"24CH"===n.typeId&&(r=24),"26CH"===n.typeId&&(r=26),"28CH"===n.typeId&&(r=28),"30CH"===n.typeId&&(r=30),"32CH"===n.typeId&&(r=32),n.channels=r;var a=0;for(p=1;p<=31;++p){var o=e.readString(22),i=e.readWord(),s=Se();s.name=o,s.sample.length=s.sample.realLen=i<<1;var u=e.readUbyte();7<u&&(u-=16),s.setFineTune(u),s.sample.volume=e.readUbyte(),s.sample.loop.start=e.readWord()<<1,s.sample.loop.length=e.readWord()<<1,s.sample.loop.enabled=2<s.sample.loop.length,s.sample.loop.type=C,s.pointer=a,a+=s.sample.length,s.setSampleIndex(0),Pe.setInstrument(p,s)}n.instruments=Pe.getInstruments(),e.goto(950),n.length=e.readUbyte(),e.jump(1);for(var l=[],d=0,p=0;p<128;++p)l[p]=e.readUbyte(),l[p]>d&&(d=l[p]);for(n.patternTable=l,e.goto(1084),p=0;p<=d;++p){for(var m=[],c=0;c<64;c++){var f,v=[];for(f=0;f<r;f++){var g=Ee(),h=e.readUint();g.setPeriod(h>>16&4095),g.effect=h>>8&15,g.instrument=h>>24&240|h>>12&15,g.param=255&h,v.push(g)}for(f=r;f<Pe.getTrackCount();f++)v.push(Ee());m.push(v)}n.patterns.push(m)}var b=[];for(p=1;p<=31;p++)if(s=Pe.getInstrument(p)){var y=s.sample.length;for(2<s.sample.loop.length&&ce.unrollShortLoops&&s.sample.loop.length<1e3&&(y=Math.min(y,s.sample.loop.start+s.sample.loop.length),s.sample.length=y),j=0;j<y;j++){var T=e.readByte();j<2&&(T=0),s.sample.data.push(T/127)}if((ce.unrollShortLoops||ce.unrollLoops)&&2<s.sample.loop.length){var w=Math.ceil(4e4/s.sample.loop.length)+1;ce.unrollLoops||(w=0);var P=!1,F=0;ce.unrollShortLoops&&s.sample.loop.length<1600&&(w=Math.floor(1e3/s.sample.loop.length),P=!0);for(var S=0;S<w;S++){var E=s.sample.loop.start,k=E+s.sample.loop.length;for(j=E;j<k;j++)s.sample.data.push(s.sample.data[j]);F+=s.sample.loop.length}P&&F&&(s.sample.loop.length+=F,s.sample.length+=F)}b.push({label:p+" "+s.name,data:p})}return fe.trigger(oe,b),n},write:function(e){var t=Pe.getSong(),n=Pe.getInstruments(),r=Pe.getTrackCount(),a=Pe.getPatternLength(),o=1084,i=0;for(u=0;u<128;u++){var s=t.patternTable[u]||0;i=Math.max(i,s)}o+=(i+1)*(256*r),n.forEach(function(e){e&&(e.setSampleIndex(0),o+=e.sample.length)});var u,l=new M(new ArrayBuffer(o),!0);for(l.writeStringSection(t.title,20),n.forEach(function(e){e?(e.sample.length=Math.min(e.sample.length,131070),l.writeStringSection(e.name,22),l.writeWord(e.sample.length>>1),l.writeUByte(e.sample.finetune),l.writeUByte(e.sample.volume),l.writeWord(e.sample.loop.start>>1),l.writeWord(e.sample.loop.length>>1)):l.clear(30)}),l.writeUByte(t.length),l.writeUByte(127),u=0;u<128;u++){s=t.patternTable[u]||0;l.writeUByte(s)}for(l.writeString(8==r?"8CHN":"M.K."),u=0;u<=i;u++)for(var d=t.patterns[u],p=0;p<a;p++)for(var m=d[p],c=0;c<r;c++){var f=m[c],v=0,g=f.instrument;15<g&&(v=16,g=f.instrument-16);var h=(v<<24)+(f.period<<16)+(g<<12)+(f.effect<<8)+f.param;l.writeUint(h)}n.forEach(function(e){var t;if(e&&e.sample.data&&e.sample.length)for(l.clear(2),u=0;u<e.sample.length-2;u++)t=e.sample.data[u]||0,l.writeByte(Math.round(127*t))}),e&&e(l)}};return e},a=function(){var e={load:function(e,t){Pe.setTrackerMode(pe),Pe.useLinearFrequency=!1;var n={patterns:[],restartPosition:1};n.typeId="ST",n.channels=4,n.title=e.readString(20,0);var r=0;for(l=1;l<=15;++l){var a=e.readString(22),o=e.readWord(),i=Se();i.name=a,i.sample.length=i.realLen=o<<1,i.sample.volume=e.readWord(),i.setFineTune(0),i.sample.loop.start=e.readWord(),i.sample.loop.length=e.readWord()<<1,i.sample.loop.enabled=2<i.sample.loop.length,i.sample.loop.type=C,i.pointer=r,r+=i.sample.length,i.setSampleIndex(0),Pe.setInstrument(l,i)}n.instruments=Pe.getInstruments(),e.goto(470),n.length=e.readUbyte(),n.speed=e.readUbyte();for(var s=[],u=0,l=0;l<128;++l)s[l]=e.readUbyte(),s[l]>u&&(u=s[l]);for(n.patternTable=s,e.goto(600),l=0;l<=u;++l){for(var d=[],p=0;p<64;p++){var m,c=[];for(m=0;m<4;m++){var f={},v=e.readUint();f.period=v>>16&4095,f.effect=v>>8&15,f.instrument=v>>24&240|v>>12&15,f.param=255&v,c.push(f)}for(m=4;m<Pe.getTrackCount();m++)c.push({note:0,effect:0,instrument:0,param:0});d.push(c)}n.patterns.push(d)}var g=[];for(l=1;l<=15;l++)if(i=Pe.getInstrument(l)){var h=i.sample.length;for(j=0;j<h;j++){var b=e.readByte();j<2&&(b=0),i.sample.data.push(b/127)}g.push({label:l+" "+i.name,data:l})}return fe.trigger(oe,g),n}};return e},l=function(){var e={load:function(e,t){function n(e){for(e.points=[],b=0;b<12;b++)e.points.push(e.raw.slice(2*b,2*b+2));return 1&e.type&&(e.enabled=!0),2&e.type&&(e.sustain=!0),4&e.type&&(e.loop=!0),e}Pe.setTrackerMode(me);var r={},a={patterns:[],instruments:[]};e.litteEndian=!0,e.goto(17),a.title=e.readString(20),e.jump(1),r.trackerName=e.readString(20),r.trackerVersion=e.readByte(),r.trackerVersion=e.readByte()+"."+r.trackerVersion,r.headerSize=e.readDWord(),r.songlength=e.readWord(),r.restartPosition=e.readWord(),r.numberOfChannels=e.readWord(),r.numberOfPatterns=e.readWord(),r.numberOfInstruments=e.readWord(),r.flags=e.readWord(),Pe.useLinearFrequency=r.flags%2==1,r.defaultTempo=e.readWord(),r.defaultBPM=e.readWord();for(var o=[],i=0,s=0;s<r.songlength;++s)o[s]=e.readUbyte(),i<o[s]&&(i=o[s]);a.patternTable=o,a.length=r.songlength,a.channels=r.numberOfChannels,a.restartPosition=r.restartPosition+1;var u=60+r.headerSize;for(e.goto(u),s=0;s<r.numberOfPatterns;s++){var l=[],d={};d.headerSize=e.readDWord(),d.packingType=e.readUbyte(),d.patternLength=e.readWord(),d.patternSize=e.readWord(),u+=d.headerSize,e.goto(u);for(var p=0;p<d.patternLength;p++){var m,c=[];for(m=0;m<r.numberOfChannels;m++){var f=Ee(),v=e.readUbyte();128&v?(1&v&&f.setIndex(e.readUbyte()),2&v&&(f.instrument=e.readUbyte()),4&v&&(f.volumeEffect=e.readUbyte()),8&v&&(f.effect=e.readUbyte()),16&v&&(f.param=e.readUbyte())):(f.setIndex(v),f.instrument=e.readUbyte(),f.volumeEffect=e.readUbyte(),f.effect=e.readUbyte(),f.param=e.readUbyte()),c.push(f)}l.push(c)}u+=d.patternSize,e.goto(u),a.patterns.push(l)}var g=[];for(s=1;s<=r.numberOfInstruments;++s){var h=Se();try{if(h.filePosition=e.index,h.headerSize=e.readDWord(),h.name=e.readString(22),h.type=e.readUbyte(),h.numberOfSamples=e.readWord(),h.samples=[],(h.sampleHeaderSize=0)<h.numberOfSamples){h.sampleHeaderSize=e.readDWord(),h.sampleHeaderSize=Math.max(h.sampleHeaderSize,40),200<h.sampleHeaderSize&&(h.sampleHeaderSize=40);for(var b=0;b<96;b++)h.sampleNumberForNotes.push(e.readUbyte());for(b=0;b<24;b++)h.volumeEnvelope.raw.push(e.readWord());for(b=0;b<24;b++)h.panningEnvelope.raw.push(e.readWord());h.volumeEnvelope.count=e.readUbyte(),h.panningEnvelope.count=e.readUbyte(),h.volumeEnvelope.sustainPoint=e.readUbyte(),h.volumeEnvelope.loopStartPoint=e.readUbyte(),h.volumeEnvelope.loopEndPoint=e.readUbyte(),h.panningEnvelope.sustainPoint=e.readUbyte(),h.panningEnvelope.loopStartPoint=e.readUbyte(),h.panningEnvelope.loopEndPoint=e.readUbyte(),h.volumeEnvelope.type=e.readUbyte(),h.panningEnvelope.type=e.readUbyte(),h.vibrato.type=e.readUbyte(),h.vibrato.sweep=e.readUbyte(),h.vibrato.depth=Math.min(e.readUbyte(),15),h.vibrato.rate=e.readUbyte(),h.fadeout=e.readWord(),h.reserved=e.readWord(),h.volumeEnvelope=n(h.volumeEnvelope),h.panningEnvelope=n(h.panningEnvelope)}}catch(e){}if(u+=h.headerSize,e.goto(u),0===h.numberOfSamples){var y=V();h.samples.push(y)}else{if(e.isEOF(1))break;for(var T=0;T<h.numberOfSamples;T++)(y=V()).length=e.readDWord(),y.loop.start=e.readDWord(),y.loop.length=e.readDWord(),y.volume=e.readUbyte(),y.finetuneX=e.readByte(),y.type=e.readUbyte(),y.panning=e.readUbyte()-128,y.relativeNote=e.readByte(),y.reserved=e.readByte(),y.name=e.readString(22),y.bits=8,h.samples.push(y),u+=h.sampleHeaderSize,e.goto(u);for(T=0;T<h.numberOfSamples;T++)if((y=h.samples[T]).length){u+=y.length,16&y.type&&(y.bits=16,y.type^=16,y.length>>=1,y.loop.start>>=1,y.loop.length>>=1),y.loop.type=y.type||0,y.loop.enabled=!!y.loop.type;var w=y.length,P=0;if(16===y.bits)for(var F=0;F<w;F++){var S=e.readShort()+P;S<-32768?S+=65536:32767<S&&(S-=65536),P=S,y.data.push(S/32768)}else for(F=0;F<w;F++)(S=e.readByte()+P)<-128?S+=256:127<S&&(S-=256),P=S,y.data.push(S/127);if(y.loop.type===k){var E=y.data.slice(y.loop.start,y.loop.start+y.loop.length);y.data=y.data.slice(0,y.loop.start+y.loop.length),y.data=y.data.concat(E.reverse()),y.loop.length=2*y.loop.length,y.length=y.loop.start+y.loop.length}e.goto(u)}}h.setSampleIndex(0),Pe.setInstrument(s,h),g.push({label:s+" "+h.name,data:s})}return fe.trigger(oe,g),a.instruments=Pe.getInstruments(),Pe.setBPM(r.defaultBPM),Pe.setAmigaSpeed(r.defaultTempo),a},write:function(e){var t=Pe.getSong(),n=Pe.getInstruments(),r=Pe.getTrackCount(),a="undefined"==typeof versionNumber?"dev":versionNumber,o=0;for(l=0;l<128;l++){var i=t.patternTable[l]||0;o=Math.max(o,i)}var s=336;for(l=0;l<=o;l++)t.patterns[l]&&(s+=9+t.patterns[l].length*r*5);for(l=1;l<n.length;l++){var u=n[l];u&&u.hasSamples()?u.samples.forEach(function(e){var t=e.length;16===e.bits&&(t*=2),s+=283+t}):s+=29}var l,d=new M(new ArrayBuffer(s),!1);for(d.writeStringSection("Extended Module: ",17),d.writeStringSection(t.title,20),d.writeByte(26),d.writeStringSection("BassoonTracker "+a,20),d.writeByte(4),d.writeByte(1),d.writeDWord(276),d.writeWord(t.length),d.writeWord(0),d.writeWord(Pe.getTrackCount()),d.writeWord(o+1),d.writeWord(n.length-1),d.writeWord(Pe.useLinearFrequency?1:0),d.writeWord(Pe.getAmigaSpeed()),d.writeWord(Pe.getBPM()),l=0;l<256;l++)d.writeUByte(t.patternTable[l]||0);for(l=0;l<=o;l++){var p=t.patterns[l],m=0,c=0;if(p&&(c=(m=p.length)*r*5),d.writeDWord(9),d.writeUByte(0),d.writeWord(m),d.writeWord(c),p)for(var f=0,v=p.length;f<v;f++)for(var g=p[f],h=0;h<r;h++){var b=g[h]||{};d.writeUByte(b.index||0),d.writeUByte(b.instrument||0),d.writeUByte(b.volumeEffect||0),d.writeUByte(b.effect||0),d.writeUByte(b.param||0)}}for(l=1;l<n.length;l++)if((u=n[l])&&u.hasSamples()){u.numberOfSamples=u.samples.length,d.writeDWord(243),d.writeStringSection(u.name,22),d.writeUByte(0),d.writeWord(u.numberOfSamples);var y=(u.volumeEnvelope.enabled?1:0)+(u.volumeEnvelope.sustain?2:0)+(u.volumeEnvelope.loop?4:0),T=(u.panningEnvelope.enabled?1:0)+(u.panningEnvelope.sustain?2:0)+(u.panningEnvelope.loop?4:0);d.writeDWord(40);for(var w=0;w<96;w++)d.writeUByte(u.sampleNumberForNotes[w]||0);for(w=0;w<12;w++){var P=u.volumeEnvelope.points[w]||[0,0];d.writeWord(P[0]),d.writeWord(P[1])}for(w=0;w<12;w++)P=u.panningEnvelope.points[w]||[0,0],d.writeWord(P[0]),d.writeWord(P[1]);d.writeUByte(u.volumeEnvelope.count||0),d.writeUByte(u.panningEnvelope.count||0),d.writeUByte(u.volumeEnvelope.sustainPoint||0),d.writeUByte(u.volumeEnvelope.loopStartPoint||0),d.writeUByte(u.volumeEnvelope.loopEndPoint||0),d.writeUByte(u.panningEnvelope.sustainPoint||0),d.writeUByte(u.panningEnvelope.loopStartPoint||0),d.writeUByte(u.panningEnvelope.loopEndPoint||0),d.writeUByte(y),d.writeUByte(T),d.writeUByte(u.vibrato.type||0),d.writeUByte(u.vibrato.sweep||0),d.writeUByte(u.vibrato.depth||0),d.writeUByte(u.vibrato.rate||0),d.writeWord(u.fadeout||0),d.writeWord(0);for(var F=0;F<u.numberOfSamples;F++){var S=u.samples[F],E=0;2<S.loop.length&&S.loop.enabled&&(E=1);var k=S.length,C=S.loop.start,A=S.loop.length;16===S.bits&&(E+=16,k*=2,C*=2,A*=2),d.writeDWord(k),d.writeDWord(C),d.writeDWord(A),d.writeUByte(S.volume),d.writeByte(S.finetuneX),d.writeUByte(E),d.writeUByte((S.panning||0)+128),d.writeUByte(S.relativeNote||0),d.writeUByte(0),d.writeStringSection(S.name||"",22)}for(F=0;F<u.numberOfSamples;F++){var x,B=0,V=0;if(16===(S=u.samples[F]).bits)for(w=0,v=S.length;w<v;w++)B=(x=Math.round(32768*S.data[w]))-V,V=x,B<-32768?B+=65536:32767<B&&(B-=65536),d.writeWord(B);else for(w=0,v=S.length;w<v;w++)B=(x=Math.round(127*S.data[w]))-V,V=x,B<-128?B+=256:127<B&&(B-=256),d.writeByte(B)}}else d.writeDWord(29),d.writeStringSection(u?u.name:"",22),d.writeUByte(0),d.writeWord(0);e&&e(d)}};return e},Se=function(){function i(e,t,n){var r=Pe.getProperties().tickTime,a=e.sustain?e.sustainPoint+1:e.count;e.loopStartPoint=Math.min(e.loopStartPoint,e.count-1),e.loopEndPoint=Math.min(e.loopEndPoint,e.count-1);var o=e.loop&&e.loopStartPoint<e.loopEndPoint;e.sustain&&e.sustainPoint<=e.loopStartPoint&&(o=!1),o&&(a=e.loopEndPoint+1);var i=0;if(t.gain)var s=t.gain,u=0,l=64;else s=t.pan,l=u=32;s.setValueAtTime((e.points[0][1]-u)/l,n);for(var d=1;d<a;d++){var p=e.points[d];i=p[0]*r,s.linearRampToValueAtTime((p[1]-u)/l,n+i)}return!!o&&c.scheduleEnvelopeLoop(t,n,2,i)}var c={type:"sample",name:"",instrumentIndex:0,sampleIndex:-1,fadeout:128,data:[]};return c.samples=[V()],c.sample=c.samples[0],c.volumeEnvelope={raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6},c.panningEnvelope={raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5},c.vibrato={},c.sampleNumberForNotes=[],c.play=function(e,t,n,r,a,o){return Pe.inFTMode()&&(t=c.getPeriodForNote(e)),ve.playSample(c.instrumentIndex,t,n,r,a,o,e)},c.noteOn=function(e){var t,n,r={};if(c.volumeEnvelope.enabled){t=ve.context.createGain();var a=c.volumeEnvelope,o=i(a,t,e);o&&(r.volume=e+o)}return c.panningEnvelope.enabled&&ve.usePanning&&(n=ve.context.createStereoPanner(),(o=i(a=c.panningEnvelope,n,e))&&(r.panning=e+o)),c.vibrato.rate&&c.vibrato.depth&&(r.ticks=0,r.vibrato=e,r.vibratoFunction=c.getAutoVibratoFunction()),{volume:t,panning:n,scheduled:r}},c.noteOff=function(e,t){function n(){t.volume.gain.cancelScheduledValues(e),t.volumeFadeOut.gain.cancelScheduledValues(e),t.volumeEnvelope&&t.volumeEnvelope.gain.cancelScheduledValues(e),t.panningEnvelope&&t.panningEnvelope.pan.cancelScheduledValues(e),t.scheduled=void 0}if(t&&t.volume){if(Pe.inFTMode()){var r=Pe.getProperties().tickTime;if(c.volumeEnvelope.enabled){if(c.volumeEnvelope.sustain&&t.volumeEnvelope){n();var a=0,o=c.volumeEnvelope.points[c.volumeEnvelope.sustainPoint];o&&(a=o[0]*r);for(var i=c.volumeEnvelope.sustainPoint;i<c.volumeEnvelope.count;i++){var s=c.volumeEnvelope.points[i];s&&t.volumeEnvelope.gain.linearRampToValueAtTime(s[1]/64,e+s[0]*r-a)}}if(c.fadeout){var u=65536/c.fadeout*r/2;t.volumeFadeOut.gain.linearRampToValueAtTime(0,e+u)}}else n(),t.volumeFadeOut.gain.linearRampToValueAtTime(0,e+.1);if(c.panningEnvelope.enabled&&ve.usePanning)for(a=0,(o=c.panningEnvelope.points[c.panningEnvelope.sustainPoint])&&(a=o[0]*r),i=c.panningEnvelope.sustainPoint;i<c.panningEnvelope.count;i++)(s=c.panningEnvelope.points[i])&&t.panningEnvelope.pan.linearRampToValueAtTime((s[1]-32)/32,e+s[0]*r-a);return 100}return n(),t.isKey&&t.volume?void t.volume.gain.linearRampToValueAtTime(0,e+.5):0}},c.scheduleEnvelopeLoop=function(e,t,n,r){r=r||0;var a=Pe.getProperties().tickTime;if(e.gain)var o=c.volumeEnvelope,i=e.gain,s=0,u=64;else o=c.panningEnvelope,i=e.pan,u=s=32;var l=o.points[o.loopStartPoint],d=l[0];if(o.loop&&o.loopStartPoint<o.loopEndPoint)for(;r<n;)for(var p=r,m=o.loopStartPoint;m<=o.loopEndPoint;m++)r=p+((l=o.points[m])[0]-d)*a,i.linearRampToValueAtTime((l[1]-s)/u,t+r);return r},c.scheduleAutoVibrato=function(e,t){var n=0;e.scheduled.ticks=e.scheduled.ticks||0;var r,a,o,i,s=Pe.getProperties().tickTime,u=-c.vibrato.rate/40,l=c.vibrato.depth/8;for(Pe.useLinearFrequency&&(l*=4),e.source&&(r=e.startPeriod,a=e.scheduled.vibratoFunction||ve.waveFormFunction.sine,o=e.scheduled.vibrato||ve.context.currentTime,i=0);n<t;){if(n+=s,r){var d=1;c.vibrato.sweep&&e.scheduled.ticks<c.vibrato.sweep&&(d=1-(c.vibrato.sweep-e.scheduled.ticks)/c.vibrato.sweep);var p=a(r,e.scheduled.ticks,u,l*d);Pe.setPeriodAtTime(e,p,o+i*s),i++}e.scheduled.ticks++}return n},c.getAutoVibratoFunction=function(){switch(c.vibrato.type){case 1:return ve.waveFormFunction.square;case 2:return ve.waveFormFunction.saw;case 3:return ve.waveFormFunction.sawInverse}return ve.waveFormFunction.sine},c.resetVolume=function(e,t){if(t.volumeFadeOut&&(t.volumeFadeOut.gain.cancelScheduledValues(e),t.volumeFadeOut.gain.setValueAtTime(1,e)),t.volumeEnvelope){t.volumeEnvelope.gain.cancelScheduledValues(e);var n=Pe.getProperties().tickTime,r=c.volumeEnvelope.sustain?c.volumeEnvelope.sustainPoint+1:c.volumeEnvelope.count;t.volumeEnvelope.gain.setValueAtTime(c.volumeEnvelope.points[0][1]/64,e);for(var a=1;a<r;a++){var o=c.volumeEnvelope.points[a];t.volumeEnvelope.gain.linearRampToValueAtTime(o[1]/64,e+o[0]*n)}}},c.getFineTune=function(){return Pe.inFTMode()?c.sample.finetuneX:c.sample.finetune},c.setFineTune=function(e){Pe.inFTMode()?(c.sample.finetuneX=e,c.sample.finetune=e>>4):(7<e&&(e-=15),c.sample.finetune=e,c.sample.finetuneX=e<<4)},c.getPeriodForNote=function(e,t){var n=0;return Pe.useLinearFrequency?(n=7680-64*(e-1),t&&(n-=c.getFineTune()/2)):(n=Te[e].period,t&&c.getFineTune()&&(n=ve.getFineTuneForNote(e,c.getFineTune()))),n},c.setSampleForNoteIndex=function(e){var t=c.sampleNumberForNotes[e-1];t!==c.sampleIndex&&"number"==typeof t&&c.setSampleIndex(t)},c.setSampleIndex=function(e){c.sampleIndex!==e&&(c.sample=c.samples[e],c.sampleIndex=e,fe.trigger(t,c.instrumentIndex))},c.hasSamples=function(){for(var e=0,t=c.samples.length;e<t;e++)if(c.samples[e].length)return!0},c.hasVibrato=function(){return c.vibrato.rate&&c.vibrato.depth},c},V=function(){var a={data:[],length:0,name:"",bits:8,volume:64,finetune:0,finetuneX:0,panning:0,relativeNote:0,loop:{enabled:!1,start:0,length:0,type:0},check:function(){for(var e=0,t=0,n=0,r=a.data.length;n<r;n++)e=Math.min(e,a.data[n]),t=Math.max(t,a.data[n]);return{min:e,max:t}}};return a},Ee=function(){var n={period:0,index:0,effect:0,instrument:0,param:0,volumeEffect:0,setPeriod:function(e){n.period=e,n.index=we[e]||0},setIndex:function(e){n.index=e;var t=Te[e];t?(n.period=t.modPeriod||t.period,1===n.period&&(n.period=0)):n.period=0},clear:function(){n.instrument=0,n.period=0,n.effect=0,n.param=0,n.index=0,n.volumeEffect=0},duplicate:function(){return{instrument:n.instrument,period:n.period,effect:n.effect,param:n.param,volumeEffect:n.volumeEffect,note:n.index}},populate:function(e){n.instrument=e.instrument||0,n.period=e.period||0,n.effect=e.effect||0,n.param=e.param||0,n.volumeEffect=e.volumeEffect||0,n.index=e.note||e.index||0}};return n};return{init:Pe.init,load:Pe.load,playSong:Pe.playSong,stop:Pe.stop,togglePlay:Pe.togglePlay,isPlaying:Pe.isPlaying,getTrackCount:Pe.getTrackCount,getSong:Pe.getSong,getStateAtTime:Pe.getStateAtTime,setCurrentSongPosition:Pe.setCurrentSongPosition,audio:ve}}();